<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>シートガチャ</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=375, maximum-scale=1.0, user-scalable=no, initial-scale=1" />
    <meta name="format-detection" content="telephone=no, address=no" />
    <link type="text/css" rel="stylesheet" href="css/anime_base.css" />
    <link type="text/css" rel="stylesheet" href="css/anime.css" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script type="text/javascript" src="js/jsdeferred.js"></script>
  </head>
  <body>
    <style type="text/css">

    </style>
    <script>
      /*
        サーバーからのパラメーター（JSONデータ形式）
        cardpack:配列。各カードパックデータ、最大20パックを想定。
        cardpack.maincard:文字列。大きいカードのファイルパス。
        cardpack.subcard:配列。小さいカードは一枚のタイル画像に対し、X軸とY軸のオフセットで指定された画像をDOM要素の背景画像として設定する。
        cardpack.subcard.xの値は0~19
        cardpack.subcard.yの値は0~4
        例: 
        cardpack.subcard.x = 1 (タイル画像の左から1を数える位置)
        cardpack.subcard.y = 2 (タイル画像の上から2を数える位置)
        */
      const JSON_DATA = {
        
        cardpack:[
          {
           maincard:"img/bigcard.jpg",
           subcard: [
              {x:1,y:2},
              {x:3,y:4},
              {x:2,y:4},
              {x:1,y:1},
              {x:0,y:0},
              {x:0,y:0}
           ]
          },
          {
           maincard:"img/bigcard.jpg",
           subcard: [
              {x:0,y:0},
              {x:1,y:2},
              {x:4,y:4},
              {x:3,y:3},
              {x:9,y:0},
              {x:19,y:4}
           ]
          },
        ]
      };
       /*カードのパック数*/
      const PACK_NUM = JSON_DATA.cardpack.length;
      /*小さいカードの幅*/
      const SMALLCARD_WIDTH = 50;
      /*小さいカードの高さ*/
      const SMALLCARD_HEIGHT = 70; 
       /*画像プリロード用の配列*/
      let loadImgs = [];

      var bg2switching = true;
      var bg1switching = true;
      var tick = 0;
      var lightTick = 0;
      var staring = true;

      /**
      *  画像のプリロード
      *  @param  imageArray  画像パスの配列
      *  @param  startFnc    開始時に呼ばれる関数
      *  @param  progressFnc ロード中に呼ばれる関数(パーセントが帰ってくる)
      *  @param  completeFnc 完了時に呼ばれる関数
      *
      */

      function preloadImage(imageArray, startFnc, progressFnc, completeFnc){  
          function preload(images, progress){
              var total = images.length;
              $(images).each(function(){
                  var src = this;
                  $('<img/>').attr('src', src).load(function() {
                      for(var i = 0; i < images.length; i++){
                          if (images[i] == src) images.splice(i, 1);
                      }
                      progress(total, total - images.length);
                  });
              });
          }

          var nowPercent = 0;
          startFnc();
          preload(imageArray, function(total, loaded){
              nowPercent = Math.ceil(100 * loaded / total);
              progressFnc(nowPercent);
              if(nowPercent >= 100){
                  completeFnc();
              }
          });
      }
      /*プリロード画像の配列初期化*/
      function initLoadImgs(){
        /*大きいカード画像*/
        
        for(let i=0; i < PACK_NUM; i++){
          loadImgs.push(JSON_DATA.cardpack[i].maincard);
        }
        /*小さいカード画像*/
        loadImgs.push("img/littlecard.jpg");

      }

      function initAnime(){
        /*大きいカード画像を生成*/
        for(let i=0; i < PACK_NUM; i++){
          let cardpack = JSON_DATA.cardpack[i];
          
          $("#cardPackWrapper").append("<div id='cardPack" + i + "' class='cardPack'>");
          $("<div id='mainCard" + i + "' class='mainCard'><img src='" + cardpack.maincard + "'></div>").appendTo("#cardPack" + i);

          /*小さいカード画像生成*/
          for(let j=0; j < cardpack.subcard.length; j++){
            let bgPosX = cardpack.subcard[j].x * SMALLCARD_WIDTH * -1; // -1はタイル画像を左方向へ移動のため
            let bgPosY = cardpack.subcard[j].y * SMALLCARD_HEIGHT * -1;// -1はタイル画像を上方向へ移動のため
            $("<div id='smallCard" + j + "' class='smallCard smallCardPos_" + j + "' style='background-position:" + bgPosX + "px " + bgPosY + "px'></div>").appendTo("#cardPack" + i);
          }
          
        }
        
      }

      $(document).ready(function() {
        Deferred.define();

        function start(){ 
          console.log('start');
          initLoadImgs();
          initAnime();
        }
        function progress(per){
           console.log(per);
        }
        function complete(){
           console.log('complete...animeStart');
           next(function () {
              $("#card").velocity({rotateX:[75,0]},{duration:500,easing:"linear"})
                        .velocity({rotateZ:360},{duration:750,easing:"linear",loop:2});
              $("#eff").velocity({scaleX:[0,2],scaleY:[0,2],opacity:[0,1]},{duration:1500,easing:"ease-in"});
              return wait(1);

          }).
          next(function () {
              $("#eff1").velocity({scaleX:[2,1],scaleY:[2,1]},{duration:1000,easing:"ease-in",queue:false});
              $("#eff1").velocity({opacity:[1,0]},{duration:300,easing:"ease-in"})
                        .velocity({opacity:[0,1]},{duration:500,easing:"ease-in",delay:200});
              return wait(0.4);

          });
        }

        var images = [
            'img/bigcard.jpg',
            'img/littlecard.jpg',
            'img/bg_a_1.jpg'
        ];
        preloadImage(images, start, progress, complete);

        
        
        
        
        
        // next(function () {
        //     doBg1Switch();
        //     return wait(0.4);

        // }).
        // next(function () {
        //     $("#char1").velocity({translateX:[355,0]},{duration:300,easing:"linear"})
        //                .velocity({translateX:[390,355]},{duration:1500,easing:"linear"});
        //     return wait(0.2);

        // }).
        // next(function () {
        //     $("#char2").velocity({translateX:[-500,0]},{duration:300,easing:"linear"})
        //                .velocity({translateX:[-550,-500]},{duration:1500,easing:"linear"});
        //     return wait(0.2);

        // }).
        // next(function () {
        //     $("#char3").velocity({translateX:[300,0]},{duration:300,easing:"linear"})
        //                .velocity({translateX:[330,300]},{duration:1500,easing:"linear"});
        //     return wait(1);

        // }).
        // next(function () {        
        //   $("#cardMask" + gachatype).velocity({scaleX:[1,0.5],scaleY:[1,0.5],opacity:1},{duration:400});
        //     return wait(0.3);
        // }).
        // next(function () {
        //   $("#bitFFF").velocity({opacity:[1,0]},{duration:200,easing:"linear"});
        //     return wait(0.2);
        // }).
        // next(function () {
        //   $(".speed").remove();
        //   doBg2Switch();    
        //   $("#bitFFF").velocity({opacity:[0,1]},{duration:100,easing:"linear"});
        //   $("#card"+gachatype).css("opacity","1");
        //   $('#btn').velocity({opacity:[1,0]},{duration:300,easing:"linear"});
        // });

        
        
        

  $('.anime-stage').bind('click',function() {

           //window.location = 'next.html';
   });

});

 


     function doBg2Switch(){
      if(bg2switching){
        next(function(){
          if(tick == 0){
            $('#bg21').css("visibility","visible");
            $('#bg22').css("visibility","hidden");
            $('#bg23').css("visibility","hidden");
            $('#bg24').css("visibility","hidden");
            tick = 1;
          }
          else if(tick == 1){
            $('#bg21').css("visibility","hidden");
            $('#bg22').css("visibility","visible");
            $('#bg23').css("visibility","hidden");
            $('#bg24').css("visibility","hidden");
            tick = 2;
          }
          else if(tick == 2){
            $('#bg21').css("visibility","hidden");
            $('#bg22').css("visibility","hidden");
            $('#bg23').css("visibility","visible");
            $('#bg24').css("visibility","hidden");
            tick = 3;
          }
          else if(tick == 3){
            $('#bg21').css("visibility","hidden");
            $('#bg22').css("visibility","hidden");
            $('#bg23').css("visibility","hidden");
            $('#bg24').css("visibility","visible");
            tick = 0;
          }
        }).
        next(function(){
          setTimeout("doBg2Switch()",125);
        });

      }
    }

      function doBg1Switch(){
      if(bg1switching){
        next(function(){
          if(lightTick == 0){
 
            $('#bg1_1').css("visibility","visible");
            $('#bg1_2').css("visibility","hidden");
            $('#bg1_3').css("visibility","hidden");
            lightTick = 1;
          }
          else if(lightTick == 1){

            $('#bg1_1').css("visibility","hidden");
            $('#bg1_2').css("visibility","visible");
            $('#bg1_3').css("visibility","hidden");
            lightTick = 2;
          }
          else if(lightTick == 2){

            $('#bg1_1').css("visibility","hidden");
            $('#bg1_2').css("visibility","hidden");
            $('#bg1_3').css("visibility","visible");
            lightTick = 0;
          }

        }).
        next(function(){
          setTimeout("doBg1Switch()",75);
        });

      }
    }

    </script>
    <div id="main">
      <!-- ▼アニメーションエリア▼ -->
      <div class='anime-stage'>
        <div id="animelim">
          <div id="scene1">
              <div id="bg_back" class="bg"><img src="img/bg_c_1.png"></div>
              <div id="bg_middle" class="bg"><img src="img/bg_b_1.png"></div>
              <div id="bg_front" class="bg"><img src="img/bg_a_1.png"></div>
              <div id="bg_pillar" class="bg bg_pillar_move"><img src="img/ef_f_1.jpg"></div>
              <div id="bg_effWrap1" class="effWrap opacityMov1">
              <div id="bg_eff1" style="background-image: url(img/ef_b_1.jpg)" class="bg_eff bgEffMove1"></div>
              </div>

              <div id="bg_effWrap2" class="effWrap opacityMov2">
              <div id="bg_eff2" style="background-image: url(img/ef_b_2.jpg)" class="bg_eff bgEffMove2"></div>
              </div>

              <div id="bg_effWrap3" class="effWrap opacityMov3">
              <div id="bg_eff3" style="background-image: url(img/ef_b_3.jpg)" class="bg_eff bgEffMove3"></div>
              </div>

              <div id="bg_effWrap4" class="effWrap opacityMov4">
              <div id="bg_eff4" style="background-image: url(img/ef_b_4.jpg)" class="bg_eff bgEffMove4"></div>
              </div>
              
              <!--<div id="card" class="card"><img src="img/ef_c_1.png"></div>-->
              <div id="eff" class="eff"><img src="img/ef_c_1.jpg"></div>
              <div id="eff1" class="eff"><img src="img/ef_d_1.jpg"></div>
              <div id="cardPackWrapper">
              </div>
          </div>


          <div id="bitFFF" class="bitFFF"><img src="img/bitFFF.png"></div>
          <div id="bit000" class="bit000"><img src="img/bit000.png"></div>
        </div>
      </div>
      <!-- ▲アニメーションエリア▲ -->
    </div><!-- /main -->
  </body>
</html>