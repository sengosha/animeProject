<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>シートガチャ</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=375, maximum-scale=1.0, user-scalable=no, initial-scale=1" />
    <meta name="format-detection" content="telephone=no, address=no" />
    <link type="text/css" rel="stylesheet" href="css/anime_base.css" />
    <link type="text/css" rel="stylesheet" href="css/anime.css" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="js/velocity.min.js"></script>
    <script type="text/javascript" src="js/jsdeferred.js"></script>
  </head>
  <body>
    <style type="text/css">

    </style>
    <script>
      /*
        サーバーからのパラメーター（JSONデータ形式）
        packs.cards:配列。小さいカードは一枚のタイル画像に対し、X軸とY軸のオフセットで指定された画像をDOM要素の背景画像として設定する。
        packs.cards.positionXの値は1~20
        packs.cards.positionYの値は1~5
        例: 
        packs.cards.positionX = 1 (タイル画像の左から1枚目位置)
        packs.cards.positionY = 2 (タイル画像の上から2枚目位置)
        */
      const JSON_DATA = {
        /*購入パック数*/
        "purchase":10,
        /*シリーズ*/
        "series":20,
        "packs":[
          {
          "charaVoice":8,
          "cards": [
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"0"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"0"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"0"
                    },
                    {
                      /*classは1の場合は特別カード（中央に表示する一番でかいカード）*/
                      "class":1,
                      "positionX":"",
                      "positionY":"",
                      "specialNo":30,
                      "rarity":"3",
                      "holo":"1"
                    }
           ]
          },

          {
          "charaVoice":8,
          "cards": [
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"0"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"0"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":0,
                      "positionX":1,
                      "positionY":2,
                      "specialNo":"",
                      "rarity":"0",
                      "holo":"1"
                    },
                    {
                      "class":1,
                      "positionX":"",
                      "positionY":"",
                      "specialNo":30,
                      "rarity":"3",
                      "holo":"0"
                    }
           ]
          },
        ],
        /*キャライラスト*/
        "charaIllust":4
      };
       /*カードのパック数*/
      const PACK_NUM = JSON_DATA.packs.length;
      /*小さいカードの幅*/
      const SMALLCARD_WIDTH = 50;
      /*小さいカードの高さ*/
      const SMALLCARD_HEIGHT = 70; 
       /*画像プリロード用の配列*/
      let loadImgs = [];
       /*ナビキャラの音声*/
      let naviVoice = [];
      var bg2switching = true;
      var bg1switching = true;
      var tick = 0;
      var lightTick = 0;
      /*この変数によって各シーンの動きを決める。
      0：最初のシーンの演出からユーザーのタップを受付までの演出
      1：タップ後にエフェクトの演出　→　魔法陣の演出
      2：カード出しの演出からナビキャラが出てくる演出
      3：演出は完全終了、結果ページに遷移
      */
      let scene = 0; 
      let waitTimer;


      /**
      *  画像のプリロード
      *  @param  imageArray  画像パスの配列
      *  @param  startFnc    開始時に呼ばれる関数
      *  @param  progressFnc ロード中に呼ばれる関数(パーセントが帰ってくる)
      *  @param  completeFnc 完了時に呼ばれる関数
      *
      */

      function preloadImage(imageArray, startFnc, progressFnc, completeFnc){  
          function preload(images, progress){
              var total = images.length;
              $(images).each(function(){
                  var src = this;
                  $('<img/>').attr('src', src).load(function() {
                      for(var i = 0; i < images.length; i++){
                          if (images[i] == src) images.splice(i, 1);
                      }
                      progress(total, total - images.length);
                  });
              });
          }

          var nowPercent = 0;
          startFnc();
          preload(imageArray, function(total, loaded){
              nowPercent = Math.ceil(100 * loaded / total);
              progressFnc(nowPercent);
              if(nowPercent >= 100){
                  completeFnc();
              }
          });
      }
      /*プリロード画像の配列初期化*/
      function initLoadImgs(){
        /*大きいカード画像*/
        for(let i=0; i < PACK_NUM; i++){
          let cardpack = JSON_DATA.packs[i];
          for(let j=0; j < cardpack.cards.length; j++){
             if(cardpack.cards[j].class == 1){
              let imgpath = "img/bigcard_" + JSON_DATA.packs[i].cards[j].specialNo + ".jpg";
              loadImgs.push(imgpath);
             }
            
            
          }
        }
        /*小さいカード画像*/
        loadImgs.push("img/littlecard.jpg");

      }

      /*アニメの初期化*/
      function initAnime(){
        
        for(let i=0; i < PACK_NUM; i++){
          let cardpack = JSON_DATA.packs[i];
          
          $("#cardPackWrapper").append("<div id='cardPack" + i + "' class='cardPack'>");
          

          /*カード画像生成*/
          for(let j=0; j < cardpack.cards.length; j++){

            /*大きいカード画像を生成*/
            if(cardpack.cards[j].class == 1){
              $("<div id='mainCard" + i + "' class='mainCard'><img src='img/bigcard_" + cardpack.cards[j].specialNo + ".jpg'></div>").prependTo("#cardPack" + i);
            }

            /*小さいカード画像を生成*/
            let bgPosX = (cardpack.cards[j].positionX - 1) * SMALLCARD_WIDTH * -1; // -1はタイル画像を左方向へ移動のため
            let bgPosY = (cardpack.cards[j].positionY - 1) * SMALLCARD_HEIGHT * -1;// -1はタイル画像を上方向へ移動のため
            $("<div id='smallCard" + j + "' class='smallCard smallCardPos_" + j + "' style='background-position:" + bgPosX + "px " + bgPosY + "px'></div>").appendTo("#cardPack" + i);
          }
          
        }
        
      }

      /*オーディオの初期化*/
      function initAudio(){
        // naviVoice[0] = new Audio();
        // naviVoice[0].src = "audio/8.mp3";
        // naviVoice[0].load();

      }

      $(document).ready(function() {
        Deferred.define();
        let startBtn = document.getElementById("startBtn");
        function start(){ 
          console.log('start');
          initLoadImgs();
          initAnime();
          
        }
        function progress(per){
           console.log(per);
        }
        function complete(){
           console.log('complete...animeStart');
           
        }

        // var images = [
        //     'img/bigcard.jpg',
        //     'img/littlecard.jpg',
        //     'img/bg_a_1.jpg'
        // ];
        preloadImage(loadImgs, start, progress, complete);
        function checkAction(){
          console.log("scene is : " + scene);
          switch(scene){
            case 0: // 魔法陣を出す前の演出
              animeStart();
              break;
            case 1: // 魔法陣を出す演出、次のパックの演出は基本魔法陣の演出から
              playEffMove(1)
              break;
            case 2:
              break;
            case 3:
              break;

          }
        }

        function animeStart(){
          next(function () {
              // $("#card").velocity({rotateX:[75,0]},{duration:500,easing:"linear"})
              //           .velocity({rotateZ:360},{duration:750,easing:"linear",loop:2});
              // $("#eff").velocity({scaleX:[0,2],scaleY:[0,2],opacity:[0,1]},{duration:1500,easing:"ease-in"});
              // return wait(1);

          }).
          next(function () {
              // $("#eff1").velocity({scaleX:[2,1],scaleY:[2,1]},{duration:1000,easing:"ease-in",queue:false});
              // $("#eff1").velocity({opacity:[1,0]},{duration:300,easing:"ease-in"})
              //           .velocity({opacity:[0,1]},{duration:500,easing:"ease-in",delay:200});
              // return wait(0.4);

          }).
          next(function () {
              //naviVoice[0].play();
              // audio.play();
              // return wait(36);
          }).
          next(function () {
            //  $("#audio").attr("src","http://develop.cardgacha.com/files/contents/showup_02.mp3");
            //    audio.play();
            //   return wait(60);
          }).
          next(function () {
            $("#s_naviChar_w").velocity({opacity:[0,1],scaleX:[1.5,1],scaleY:[1.5,1]},{duration:500,easing:"ease-in"});
            $("#s_naviChar").remove();
            waitTimer = wait(1);
            return waitTimer;
          }).
          next(function () {
            $("#bg_back").velocity({translateX:[750,0]},{duration:1000,easing:"ease-in"});
            waitTimer = wait(1);
            return waitTimer;
          }).
          next(function () {
            // $("#bitFFF").velocity({opacity:[1,0]},{duration:200,easing:"linear"});
            // waitTimer = wait(0.2);
            // return waitTimer;
          }).
          next(function () {
            
            //$(".effWrap,.bg_eff").removeClass("anim");
            // $("#bitFFF").velocity({opacity:[0,1]},{duration:200,easing:"linear"});
            // waitTimer = wait(0);
            // return waitTimer;
          }).
          next(function () {
            $("#bgMask").velocity({opacity:[0.8,0]},{duration:1000,easing:"linear"});
            //$("#bg_pillar").velocity({opacity:[1,0]},{duration:200,easing:"linear"});
            $(".effWrap").velocity({translateX:[1280,0],opacity:[0,1]},{duration:1600,easing:"easeInCubic"});
            $("#pillarWrap").velocity({opacity:[0,1]},{duration:1600,easing:"linear",display:"none"});
            waitTimer = wait(1.6);
            return waitTimer;
          }).
          next(function () {
            playEffMove(1);
          });
        }
        /*カードを出す前の魔法陣演出*/
        function playEffMove(rarity){
          next(function () {
              $("#magicSquare1").velocity({opacity:[1,1],scaleX:[1,-1],scaleY:[1,0],rotateZ:[0,540]},{duration:400,easing:"ease-in"})
                                .velocity({rotateZ:[-360,0]},{duration:12000,easing:"linear",loop:true});
              waitTimer = wait(0.4);
            return waitTimer;

          }).
          next(function () {
              $("#magicSquareWrap").velocity({opacity:[1,0],scaleX:[1,1.2],scaleY:[1,1.2]},{duration:400,easing:"linear"});
              waitTimer = wait(0.8);
            return waitTimer;

          }).
          next(function () {
              $(".thunder1").css("display","block");
              waitTimer = wait(2);
              return waitTimer;
          }).
          next(function () {
              $("#bitFFF").velocity({opacity:[1,0]},{duration:1500,easing:"ease-in"});
              $("#animelim").velocity({scaleX:[1.5,1],scaleY:[1.5,1]},{duration:1500,easing:"ease-in"});
              waitTimer = wait(2);
              return waitTimer;
          });
        }
        
        /*アニメ開始のナビキャラが出て来る演出*/
        next(function () {
            waitTimer = wait(1);
            return waitTimer;
        })
        next(function () {
            $("#s_naviChar_f").velocity({opacity:[1,0]},{duration:300,easing:"linear"});
            waitTimer = wait(0.3);
            return waitTimer;
        }).
        next(function () {
            
            $("#s_naviChar").velocity({opacity:[1,0]},{duration:500,easing:"linear"});
            waitTimer = wait(0.5);
            return waitTimer;
        }).
        next(function () {
            $("#s_naviChar_f").velocity({opacity:[0,1]},{duration:500,easing:"linear"});
            waitTimer = wait(0.5);
            return waitTimer;
        });
        // next(function () {
        //     $("#char2").velocity({translateX:[-500,0]},{duration:300,easing:"linear"})
        //                .velocity({translateX:[-550,-500]},{duration:1500,easing:"linear"});
        //     return wait(0.2);

        // }).
        // next(function () {
        //     $("#char3").velocity({translateX:[300,0]},{duration:300,easing:"linear"})
        //                .velocity({translateX:[330,300]},{duration:1500,easing:"linear"});
        //     return wait(1);

        // }).
        // next(function () {        
        //   $("#cardMask" + gachatype).velocity({scaleX:[1,0.5],scaleY:[1,0.5],opacity:1},{duration:400});
        //     return wait(0.3);
        // }).
        // next(function () {
        //   $("#bitFFF").velocity({opacity:[1,0]},{duration:200,easing:"linear"});
        //     return wait(0.2);
        // }).
        // next(function () {
        //   $(".speed").remove();
        //   doBg2Switch();    
        //   $("#bitFFF").velocity({opacity:[0,1]},{duration:100,easing:"linear"});
        //   $("#card"+gachatype).css("opacity","1");
        //   $('#btn').velocity({opacity:[1,0]},{duration:300,easing:"linear"});
        // });

         
  startBtn.addEventListener('click',function(){
    console.log("btn click");
    //initAudio();
    //audio.load();
    startBtn.remove();
    checkAction();
    //playEffMove()
  })      

  $('.anime-stage').bind('click',function() {
    console.log("stage click");
    switch(scene){
      case 0:
        //scene = 1;
        break;
    }
    //animeStart();
    //window.location = 'next.html';
   });


});

 


     function doBg2Switch(){
      if(bg2switching){
        next(function(){
          if(tick == 0){
            $('#bg21').css("visibility","visible");
            $('#bg22').css("visibility","hidden");
            $('#bg23').css("visibility","hidden");
            $('#bg24').css("visibility","hidden");
            tick = 1;
          }
          else if(tick == 1){
            $('#bg21').css("visibility","hidden");
            $('#bg22').css("visibility","visible");
            $('#bg23').css("visibility","hidden");
            $('#bg24').css("visibility","hidden");
            tick = 2;
          }
          else if(tick == 2){
            $('#bg21').css("visibility","hidden");
            $('#bg22').css("visibility","hidden");
            $('#bg23').css("visibility","visible");
            $('#bg24').css("visibility","hidden");
            tick = 3;
          }
          else if(tick == 3){
            $('#bg21').css("visibility","hidden");
            $('#bg22').css("visibility","hidden");
            $('#bg23').css("visibility","hidden");
            $('#bg24').css("visibility","visible");
            tick = 0;
          }
        }).
        next(function(){
          setTimeout("doBg2Switch()",125);
        });

      }
    }

      function doBg1Switch(){
      if(bg1switching){
        next(function(){
          if(lightTick == 0){
 
            $('#bg1_1').css("visibility","visible");
            $('#bg1_2').css("visibility","hidden");
            $('#bg1_3').css("visibility","hidden");
            lightTick = 1;
          }
          else if(lightTick == 1){

            $('#bg1_1').css("visibility","hidden");
            $('#bg1_2').css("visibility","visible");
            $('#bg1_3').css("visibility","hidden");
            lightTick = 2;
          }
          else if(lightTick == 2){

            $('#bg1_1').css("visibility","hidden");
            $('#bg1_2').css("visibility","hidden");
            $('#bg1_3').css("visibility","visible");
            lightTick = 0;
          }

        }).
        next(function(){
          setTimeout("doBg1Switch()",75);
        });

      }
    }

    </script>
    <div id="main">
      <!-- ▼アニメーションエリア▼ -->
      <div class='anime-stage'>
        <div id="animelim">
          <div id="scene1">
              <div id="bg_back" class="bg"><img src="img/bg_light_1.png"></div>
              <div id="bg_middle" class="bg"><img src="img/bg_wall_1.png"></div>
              <div id="bg_front" class="bg"><img src="img/bg_device_1.png"></div>
              <div id="pillarWrap">
              <div id="bg_pillar" class="bg bg_pillar_move"><img src="img/ef_light_1.jpg"></div>
              </div>
              <div id="bgMask" class="bit000"><img src="img/bit000.png"></div>
               <!-- PC版用に残す
              <div id="bg_effWrap1" class="effWrap anim">
              <div id="bg_eff1" style="background-image: url(img/ef_line_1.gif)" class="bg_eff anim"></div>
              </div>

              <div id="bg_effWrap2" class="effWrap anim">
              <div id="bg_eff2" style="background-image: url(img/ef_line_2.gif)" class="bg_eff anim"></div>
              </div>

              <div id="bg_effWrap3" class="effWrap anim">
              <div id="bg_eff3" style="background-image: url(img/ef_line_3.gif)" class="bg_eff anim"></div>
              </div>

              <div id="bg_effWrap4" class="effWrap anim">
              <div id="bg_eff4" style="background-image: url(img/ef_line_4.gif)" class="bg_eff anim"></div>
              </div>
              -->
              <div id="bg_effWrap1" class="effWrap">
              <div id="bg_eff1" style="background-image: url(img/ef_line_1.gif)" class="bg_eff"></div>
              </div>

              <div id="bg_effWrap2" class="effWrap">
              <div id="bg_eff2" style="background-image: url(img/ef_line_2.gif)" class="bg_eff"></div>
              </div>

              <div id="bg_effWrap3" class="effWrap">
              <div id="bg_eff3" style="background-image: url(img/ef_line_3.gif)" class="bg_eff"></div>
              </div>

              <div id="bg_effWrap4" class="effWrap">
              <div id="bg_eff4" style="background-image: url(img/ef_line_4.gif)" class="bg_eff"></div>
              </div>
              <!-- タップする前に出てくるナビキャラ-->
              <div id="s_naviCharWrap" class="anim">
                <div id="s_naviChar" class="s_naviChar"><img src="img/chara_unit_2.png" /></div>
                <div id="s_naviChar_f" class="s_naviChar"><img src="img/chara_unit_1.png" /></div>
                <div id="s_naviChar_w" class="s_naviChar"><img src="img/chara_unit_3.png" /></div>
              </div>
              <div id="magicSquare1" class="magicSquare"><img src="img/ef_circle_1.jpg" /></div>
              <div id="magicSquareWrap">
                <div id="magicSquare2" class="magicSquare anim"><img src="img/ef_circle_2.jpg" /></div>
              </div>


              <!-- 雷エフェクトグループ-->
              <div id="thunder1_1" class="thunder1 anim"><img src="img/ef_thunder_0_1.jpg" /></div>
              <div id="thunder1_2" class="thunder1 anim"><img src="img/ef_thunder_0_2.jpg" /></div>
              <div id="thunder1_3" class="thunder1 anim"><img src="img/ef_thunder_0_3.jpg" /></div>
              <div id="thunder1_4" class="thunder1 anim"><img src="img/ef_thunder_0_4.jpg" /></div>
              <div id="thunder1_5" class="thunder1 anim"><img src="img/ef_thunder_0_5.jpg" /></div>
              <div id="thunder1_6" class="thunder1 anim"><img src="img/ef_thunder_0_6.jpg" /></div>

              <!--<div id="card" class="card"><img src="img/ef_c_1.png"></div>-->
              <div id="eff" class="eff"><img src="img/card_big_1.jpg"></div>
              <div id="eff1" class="eff"><img src="img/ef_flare_1.jpg"></div>
              <div id="cardPackWrapper">
              </div>


              
          </div>


          <div id="bitFFF" class="bitFFF"><img src="img/bitFFF.png"></div>
          <div id="bit000" class="bit000"><img src="img/bit000.png"></div>
          <div id="startBtn">Click to Start!!</div>
          <!--<audio id="audio" src="http://develop.cardgacha.com/files/contents/showup_01.mp3" preload="auto"></audio>-->
          
        </div>
      </div>
      <!-- ▲アニメーションエリア▲ -->
    </div><!-- /main -->
  </body>
</html>